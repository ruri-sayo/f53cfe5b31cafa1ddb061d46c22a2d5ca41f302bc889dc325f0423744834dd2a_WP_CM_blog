---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { getFullPath } from '../consts';
import heroData from '../data/hero.json';
import toolsData from '../data/tools.json';
import gamesData from '../data/games.json';
// novelデータは型が未確定なため、一旦jsonとして読み込むか、feature/astro-migrationフェーズ後半で実装を完成させる
// import homeNovelData from '../data/home_novel.json'; 

// 記事取得とソート
const posts = (await getCollection('posts')).sort(
	(a, b) => {
    const dateA = a.data.date ? new Date(a.data.date).valueOf() : 0;
    const dateB = b.data.date ? new Date(b.data.date).valueOf() : 0;
    return dateB - dateA;
  }
).slice(0, 5); // 最新5件

// ピックアップツールID
const featuredToolIds = ["kazukazoe", "sky_high", "diff", "count"];

// ヒーローデータ
const hero = heroData;
---

<BaseLayout>
	<!-- ヒーローエリア -->
	{hero.enabled && (
		<section
			class={`${hero.bg_class || 'bg-gradient-to-r from-blue-500 to-purple-600'} text-white p-8 rounded-lg mb-8 shadow-lg`}
		>
			<h2 class="text-2xl md:text-3xl font-bold mb-4">{hero.title}</h2>
			<p class="text-white/90 mb-4">{hero.message}</p>
			{hero.button?.enabled && (
				<a href={getFullPath(hero.button.url)}
					class="inline-block px-6 py-2 bg-white text-blue-600 rounded-lg font-semibold hover:bg-gray-100 transition-colors">
					{hero.button.text}
				</a>
			)}
		</section>
	)}

	<section class="mb-16">
		<div class="grid grid-cols-1 md:grid-cols-2 gap-8">
			<!-- 左：新着記事 -->
			<div class="space-y-4">
				<h2 class="text-2xl font-semibold border-b pb-2 mb-4">
					<a href={getFullPath('/posts/')} class="hover:text-blue-600">記事一覧 &rarr;</a>
				</h2>
				<h3>最新記事はこちら↓</h3>
				{posts.map((post) => {
					const tags = post.data.tags 
            ? (Array.isArray(post.data.tags) ? post.data.tags : [post.data.tags]) 
            : (post.data.categories ? (Array.isArray(post.data.categories) ? post.data.categories : [post.data.categories]) : []);
          const tagText = tags.join(', ');
          
          // 年/月/日/タイトル のパスを生成 (Jekyll互換)
          const dateObj = post.data.date ? new Date(post.data.date) : new Date();
          const year = dateObj.getFullYear();
          const month = String(dateObj.getMonth() + 1).padStart(2, '0');
          const day = String(dateObj.getDate()).padStart(2, '0');
          // スラグが日本語を含む場合など、ファイル名ベースのスラグを使用する前提
          const slug = post.slug.split('-').slice(3).join('-') || post.slug; 
          // ※注: Astroのデフォルトslugはファイル名全体なので、Jekyll互換URLを作るロジックは別途検討が必要。
          // ここでは一旦シンプルに /posts/slug/ とするが、Phase 2の後半でURL構造を合わせる作業をする。
          // Jekyllのpermalink: /posts/:year/:month/:day/:title/
          
          // Astro collectionsのslugはファイル名から日付部分を除去してくれる場合とそうでない場合がある（設定依存）。
          // 今回はmigration用の設定をしていないので、post.slugをそのまま使うと "2025-10-14-bibouroku" のようになる。
          // リンク先は動的ルーティング側で合わせる必要がある。ここでは仮に slug をそのまま使う。
          const postUrl = getFullPath(`/posts/${post.slug}/`);

					return (
						<a href={postUrl}
							class="block bg-white p-4 rounded-lg shadow-sm hover:shadow-md transition-shadow">
							<h3 class="text-lg font-bold hover:text-blue-600">{post.data.title}</h3>
							{post.data.description && (
								<p class="text-gray-600 mt-1">{post.data.description.substring(0, 120)}...</p>
							)}
							<div class="mt-3 flex items-center justify-between text-sm text-gray-500">
								<time datetime={post.data.date?.toISOString()}>{post.data.date?.toLocaleDateString('ja-JP')}</time>
								{tagText ? (
									<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-semibold">{tagText}</span>
								) : (
									<span class="bg-gray-100 text-gray-600 px-2 py-1 rounded-full text-xs">untagged</span>
								)}
							</div>
						</a>
					);
				})}
			</div>


			<!-- 右：ツール導線 -->
			<div class="space-y-4">
				<h2 class="text-2xl font-semibold border-b pb-2 mb-4">
					<a href={getFullPath('/tools/')} class="hover:text-blue-600">便利なツール &rarr;</a>
				</h2>

				{featuredToolIds.map((id) => {
					const tool = toolsData.find(t => t.id === id);
					if (!tool) return null;
					return (
						<a href={getFullPath(tool.url)}
							class="block bg-white p-4 rounded-lg shadow-sm hover:shadow-md transition-shadow">
							<h3 class="text-lg font-bold hover:text-blue-600">
								{tool.title}
							</h3>
							{tool.description && (
								<p class="text-gray-600 mt-1">{tool.description}</p>
							)}
							{tool.tag && (
								<div class="mt-3 flex justify-end">
									<span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-semibold">
										{tool.tag}
									</span>
								</div>
							)}
						</a>
					);
				})}
			</div>
		</div>
	</section>

	<section class="grid grid-cols-1 md:grid-cols-2 gap-8">
		<!-- Novel セクション -->
		<div class="space-y-4">
			<h2 class="text-2xl font-semibold border-b pb-2 mb-4">
				<a href={getFullPath('/novel/')} class="hover:text-blue-600">Novel &rarr;</a>
			</h2>
      {/* Novel機能は準備中 */}
      <div class="bg-white p-4 rounded-lg shadow-sm">
        <p class="text-gray-600">小説コーナーは移行作業中です。</p>
      </div>
		</div>

		<!-- Game セクション -->
		<div class="space-y-4">
			<h2 class="text-2xl font-semibold border-b pb-2 mb-4">
				<a href={getFullPath('/game/')} class="hover:text-blue-600">Game / App &rarr;</a>
			</h2>

			{gamesData.map((game) => (
				<a href={game.url.startsWith('http') ? game.url : getFullPath(game.url)}
					class="block bg-white p-4 rounded-lg shadow-sm hover:shadow-md transition-shadow">
					<div class="flex items-center justify-between">
						<div class="flex-1">
							<div class="flex items-center gap-2 mb-1">
								{/* プラットフォームアイコン */}
								{game.platform === "pc" ? (
									<svg class="w-4 h-4 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"
										title="PC推奨">
										<rect x="2" y="3" width="20" height="14" rx="2" stroke-width="1.5" />
										<path d="M8 21h8M12 17v4" stroke-width="1.5" />
									</svg>
								) : (
									<svg class="w-4 h-4 text-green-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"
										title="スマホ対応">
										<rect x="5" y="2" width="14" height="20" rx="2" stroke-width="1.5" />
										<circle cx="12" cy="18" r="1" fill="currentColor" />
									</svg>
								)}
								<p class="text-sm text-gray-500 uppercase tracking-wide">{game.tag || 'game/app'}</p>
							</div>
							<h3 class="text-xl font-bold hover:text-blue-600">{game.title}</h3>
							{game.description && (
								<p class="text-gray-600 mt-1">{game.description}</p>
							)}
						</div>
						<span class="text-blue-600 text-lg">&rarr;</span>
					</div>
				</a>
			))}
		</div>
	</section>
</BaseLayout>
