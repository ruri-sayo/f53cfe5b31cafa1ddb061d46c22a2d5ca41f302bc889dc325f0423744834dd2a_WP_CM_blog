---
/**
 * 記事一覧ページ
 */
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { getFullPath } from '../../consts';

// 記事取得とソート（新しい順）
const posts = (await getCollection('posts')).sort(
  (a, b) => {
    const dateA = a.data.date ? new Date(a.data.date).valueOf() : 0;
    const dateB = b.data.date ? new Date(b.data.date).valueOf() : 0;
    return dateB - dateA;
  }
);
---

<BaseLayout title="記事一覧" description="城上コードメモの記事一覧">
  <section class="space-y-6">
    <h1 class="text-3xl font-bold mb-4">記事一覧</h1>
    <p class="text-gray-600 mb-6">全{posts.length}件の記事があります。</p>

    <div class="space-y-4">
      {posts.map((post) => {
        const tags = post.data.tags 
          ? (Array.isArray(post.data.tags) ? post.data.tags : [post.data.tags]) 
          : (post.data.categories ? (Array.isArray(post.data.categories) ? post.data.categories : [post.data.categories]) : []);
        const tagText = tags.join(', ');
        const postUrl = getFullPath(`/posts/${post.slug}/`);

        return (
          <a href={postUrl}
            class="block bg-white p-4 rounded-lg shadow-sm hover:shadow-md transition-shadow">
            <h2 class="text-lg font-bold hover:text-blue-600">{post.data.title}</h2>
            {post.data.description && (
              <p class="text-gray-600 mt-1">{post.data.description.substring(0, 150)}...</p>
            )}
            <div class="mt-3 flex items-center justify-between text-sm text-gray-500">
              <time datetime={post.data.date?.toISOString()}>{post.data.date?.toLocaleDateString('ja-JP')}</time>
              {tagText ? (
                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-semibold">{tagText}</span>
              ) : (
                <span class="bg-gray-100 text-gray-600 px-2 py-1 rounded-full text-xs">untagged</span>
              )}
            </div>
          </a>
        );
      })}
    </div>
  </section>
</BaseLayout>
