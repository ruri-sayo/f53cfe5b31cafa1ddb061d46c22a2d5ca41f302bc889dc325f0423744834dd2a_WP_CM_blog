<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>日本のスキー場 標高比較グラフ</title>

  <!-- このページ専用のファビコン（同じディレクトリに sky_koara.ico がある前提） -->
  <link rel="icon" href="./sky_koara.ico" type="image/x-icon">

  <!-- Tailwind CSSを読み込み -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- D3.jsを読み込み -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <!-- YAMLパーサー（js-yaml） -->
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    /* フォント設定 */
    body {
      font-family: 'Inter', 'Noto Sans JP', sans-serif;
    }
    /* ツールチップのスタイル */
    .tooltip {
      position: absolute;
      text-align: left;
      padding: 8px;
      font-size: 12px;
      background: rgba(0, 0, 0, 0.85);
      color: white;
      border-radius: 8px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 10;
    }
    /* 軸の線のスタイル */
    .domain {
      stroke: #d1d5db; /* gray-300 */
    }
    /* 軸の目盛線のスタイル */
    .tick line {
      stroke: #e5e7eb; /* gray-200 */
      stroke-dasharray: 2,2;
    }
    /* 軸のテキストのスタイル */
    .tick text {
      fill: #4b5563; /* gray-600 */
      font-size: 10px;
    }
    /* 標高範囲を示すバーのスタイル */
    .elevation-bar {
      transition: fill 0.2s ease-in-out, opacity 0.2s ease-in-out;
    }
    .elevation-bar:hover {
      opacity: 1.0;
    }
    /* ソートボタンのスタイル（セレクトの装飾用） */
    .sort-select {
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      background-color: white;
      font-size: 14px;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 flex items-center justify-center min-h-screen p-4">

  <div class="w-full max-w-full lg:max-w-7xl bg-white p-4 sm:p-8 rounded-2xl shadow-lg">
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
      <div>
        <h1 class="text-xl sm:text-3xl font-bold text-gray-900 mb-2">日本のスキー場 標高比較</h1>
        <p class="text-gray-600">
          各スキー場の標高範囲（Y軸）を比較できます。<br class="sm:hidden" />
          並び替え条件を変えて眺めてみてください。
        </p>
      </div>

      <!-- ソートUI（スマホ対応） -->
      <div id="controls" class="flex flex-col sm:flex-row gap-2 items-start sm:items-center">
        <div class="flex items-center gap-2">
          <label for="sort-key" class="text-sm text-gray-700 whitespace-nowrap">並び替え項目</label>
          <select id="sort-key" class="sort-select">
            <option value="region">地域</option>
            <option value="pref">都道府県</option>
            <option value="elevation">標高（最高標高）</option>
          </select>
        </div>
        <div class="flex items-center gap-2">
          <label for="sort-order" class="text-sm text-gray-700 whitespace-nowrap">順序</label>
          <select id="sort-order" class="sort-select">
            <option value="desc">降順（高い→低い / 後半→前半）</option>
            <option value="asc">昇順（低い→高い / 前半→後半）</option>
          </select>
        </div>
      </div>
    </div>

    <!-- グラフを描画するコンテナ -->
    <div id="chart-container" class="w-full h-full overflow-x-auto"></div>

    <!-- ツールチップ表示用のdiv -->
    <div id="tooltip" class="tooltip"></div>
  </div>

  <script>
    // ------------ 設定ここから ------------

    // 都道府県 → 地域 のマッピング（ざっくり日本全体対応）
    const prefToRegion = {
      "北海道": "北海道",
      "青森": "東北", "岩手": "東北", "宮城": "東北", "秋田": "東北", "山形": "東北", "福島": "東北",
      "茨城": "北関東・甲信", "栃木": "北関東・甲信", "群馬": "北関東・甲信", "山梨": "北関東・甲信", "長野": "北関東・甲信",
      "新潟": "北陸", "富山": "北陸", "石川": "北陸", "福井": "北陸",
      "岐阜": "中部", "静岡": "中部", "愛知": "中部", "三重": "中部",
      "滋賀": "近畿", "京都": "近畿", "大阪": "近畿", "兵庫": "近畿", "奈良": "近畿", "和歌山": "近畿",
      "鳥取": "中国", "島根": "中国", "岡山": "中国", "広島": "中国", "山口": "中国",
      "徳島": "四国", "香川": "四国", "愛媛": "四国", "高知": "四国",
      "福岡": "九州", "佐賀": "九州", "長崎": "九州", "熊本": "九州", "大分": "九州", "宮崎": "九州", "鹿児島": "九州",
      "沖縄": "沖縄"
    };

    // 地域の表示順
    const regionOrder = [
      "北海道", "東北", "北関東・甲信", "北陸", "中部", "近畿", "中国", "四国", "九州", "沖縄", "その他"
    ];

    // 地域ごとの色
    const regionColors = {
      "北海道": "#0ea5e9",
      "東北": "#22c55e",
      "北関東・甲信": "#6366f1",
      "北陸": "#ca8a04",
      "中部": "#f97316",
      "近畿": "#ef4444",
      "中国": "#14b8a6",
      "四国": "#8b5cf6",
      "九州": "#e11d48",
      "沖縄": "#06b6d4",
      "その他": "#6b7280"
    };

    // YAMLファイル名（同じディレクトリに配置）
    const DATA_FILE = "sky_high.yml";

    // ------------ ここまで設定 ------------

    let skiData = [];        // {name, pref, region, high, low, courses}
    let sortKey = "region";  // "region" | "pref" | "elevation"
    let sortOrder = "desc";  // "asc" | "desc"

    const tooltip = d3.select("#tooltip");

    function getRegionFromPref(pref) {
      return prefToRegion[pref] || "その他";
    }

    function parseYamlToData(yamlText) {
      // YAMLをパース
      const raw = jsyaml.load(yamlText);

      // 配列でなければ空配列扱い
      if (!Array.isArray(raw)) return [];

      // alt_top / alt_bottom があるものだけ使う
      return raw
        .filter(d => d.alt_top != null && d.alt_bottom != null)
        .map(d => {
          const high = Number(d.alt_top);
          const low = Number(d.alt_bottom);
          // corse が無い場合は null（調査中表示）
          const courses = d.corse != null && d.corse !== "" ? Number(d.corse) : null;
          const pref = d.pref || "";

          return {
            name: d.name || "名称不明",
            pref: pref,
            region: d.region || getRegionFromPref(pref),
            high: isNaN(high) ? null : high,
            low: isNaN(low) ? null : low,
            courses: isNaN(courses) ? null : courses
          };
        })
        .filter(d => d.high != null && d.low != null);
    }

    function getSortedData() {
      const data = [...skiData];
      data.sort((a, b) => {
        let comp = 0;

        if (sortKey === "region") {
          const idxA = regionOrder.indexOf(a.region);
          const idxB = regionOrder.indexOf(b.region);
          const safeA = idxA === -1 ? regionOrder.length : idxA;
          const safeB = idxB === -1 ? regionOrder.length : idxB;
          comp = safeA - safeB;
          if (comp === 0) {
            // 同じ地域内では最高標高でソート
            comp = a.high - b.high;
          }
        } else if (sortKey === "pref") {
          // 都道府県名でソート（日本語ロケール）
          comp = a.pref.localeCompare(b.pref, "ja");
          if (comp === 0) {
            comp = a.high - b.high;
          }
        } else if (sortKey === "elevation") {
          // 最高標高でソート
          comp = a.high - b.high;
        }

        // 昇順/降順の反転
        if (sortOrder === "desc") comp = -comp;
        return comp;
      });
      return data;
    }

    function updateChart() {
      if (!skiData.length) return;

      const container = document.getElementById("chart-container");
      container.innerHTML = "";

      const data = getSortedData();

      const numBars = data.length;
      const barWidth = 16;
      const barPadding = 8;

      const margin = { top: 20, right: 20, bottom: 150, left: 70 };
      const innerHeight = 500 - margin.top - margin.bottom;

      // グラフの横幅は棒の本数に比例。スマホでも横スクロールで見られる想定。
      const width = numBars * (barWidth + barPadding) + margin.left + margin.right;
      const height = 500;

      const svg = d3.select("#chart-container")
        .append("svg")
        .attr("width", width)
        .attr("height", height)
        .append("g")
        .attr("transform", `translate(${margin.left}, ${margin.top})`);

      const innerWidth = width - margin.left - margin.right;

      const x = d3.scaleBand()
        .domain(data.map(d => d.name))
        .range([0, innerWidth])
        .padding(0.2);

      const y = d3.scaleLinear()
        .domain([0, d3.max(data, d => d.high) * 1.05])
        .range([innerHeight, 0]);

      const xAxis = svg.append("g")
        .attr("transform", `translate(0, ${innerHeight})`)
        .call(d3.axisBottom(x));

      xAxis.selectAll("text")
        .attr("transform", "translate(-10,0)rotate(-65)")
        .style("text-anchor", "end");

      xAxis.selectAll(".domain, .tick line").remove();

      svg.append("g")
        .call(
          d3.axisLeft(y)
            .tickFormat(d => `${d}m`)
            .tickSize(-innerWidth)
            .tickPadding(10)
        )
        .call(g => g.select(".domain").remove());

      svg.append("g")
        .selectAll("rect")
        .data(data, d => d.name)
        .enter()
        .append("rect")
        .attr("class", "elevation-bar")
        .attr("x", d => x(d.name))
        .attr("y", d => y(d.high))
        .attr("width", x.bandwidth())
        .attr("height", d => Math.max(0, y(d.low) - y(d.high)))
        .style("fill", d => regionColors[d.region] || "#888888")
        .attr("opacity", 0.85)
        .attr("rx", 2)
        .attr("ry", 2)
        .on("mouseover", function (event, d) {
          d3.select(this).style("opacity", 1.0);
          const courseText = d.courses != null ? `${d.courses}本` : "調査中";
          tooltip.transition().duration(200).style("opacity", 0.9);
          tooltip
            .html(
              `<strong>${d.name}</strong><br/>
               地域: ${d.region}<br/>
               都道府県: ${d.pref || "不明"}<br/>
               標高: ${d.low.toLocaleString()}m - ${d.high.toLocaleString()}m<br/>
               コース数: ${courseText}`
            )
            .style("left", (event.pageX + 15) + "px")
            .style("top", (event.pageY - 28) + "px");
        })
        .on("mouseout", function () {
          d3.select(this).style("opacity", 0.85);
          tooltip.transition().duration(500).style("opacity", 0);
        });
    }

    function initControls() {
      const sortKeySelect = document.getElementById("sort-key");
      const sortOrderSelect = document.getElementById("sort-order");

      sortKeySelect.value = sortKey;
      sortOrderSelect.value = sortOrder;

      sortKeySelect.addEventListener("change", () => {
        sortKey = sortKeySelect.value;
        updateChart();
      });

      sortOrderSelect.addEventListener("change", () => {
        sortOrder = sortOrderSelect.value;
        updateChart();
      });
    }

    function loadData() {
      fetch(DATA_FILE)
        .then(res => {
          if (!res.ok) {
            throw new Error("データファイルの読み込みに失敗しました");
          }
          return res.text();
        })
        .then(text => {
          skiData = parseYamlToData(text);
          initControls();
          updateChart();
        })
        .catch(err => {
          console.error(err);
          document.getElementById("chart-container").innerText =
            "データの読み込みに失敗しました。sky_high.yml の場所や内容を確認してください。";
        });
    }

    document.addEventListener("DOMContentLoaded", () => {
      loadData();
      // 画面サイズ変更時も再描画（幅が変わったとき用）
      window.addEventListener("resize", () => updateChart());
    });
  </script>

</body>
</html>
