---
/**
 * 小説動的ルーティング
 * シリーズトップ(index.md)とエピソード両方を処理
 */
import { getCollection, type CollectionEntry } from 'astro:content';
import NovelSeriesLayout from '../../layouts/NovelSeriesLayout.astro';
import NovelEpisodeLayout from '../../layouts/NovelEpisodeLayout.astro';

export async function getStaticPaths() {
  const allNovel = await getCollection('novel');
  
  return allNovel.map((entry) => {
    // シリーズインデックスの場合
    if (entry.data.is_series_index) {
      // 同シリーズのエピソードを取得
      const episodes = allNovel
        .filter((e) => e.data.series_id === entry.data.series_id && !e.data.is_series_index)
        .sort((a, b) => (a.data.episode ?? 0) - (b.data.episode ?? 0));
      
      return {
        params: { slug: entry.data.series_id },
        props: { entry, episodes, isSeries: true },
      };
    }
    
    // エピソードの場合
    return {
      params: { slug: entry.slug },
      props: { entry, episodes: [], isSeries: false },
    };
  });
}

interface Props {
  entry: CollectionEntry<'novel'>;
  episodes: CollectionEntry<'novel'>[];
  isSeries: boolean;
}

const { entry, episodes, isSeries } = Astro.props;
---

{isSeries ? (
  <NovelSeriesLayout series={entry} episodes={episodes} />
) : (
  <NovelEpisodeLayout episode={entry} />
)}
