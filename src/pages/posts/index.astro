---
/**
 * 記事一覧ページ
 */
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { getPostUrl } from '../../consts';

// 記事取得とソート（新しい順）
const allPosts = (await getCollection('posts')).sort(
  (a, b) => {
    const dateA = a.data.date ? new Date(a.data.date).valueOf() : 0;
    const dateB = b.data.date ? new Date(b.data.date).valueOf() : 0;
    return dateB - dateA;
  }
);

// クライアントサイド検索用のデータを作成
const postsForJson = allPosts.map((post) => {
  const tags = post.data.tags 
    ? (Array.isArray(post.data.tags) ? post.data.tags : [post.data.tags]) 
    : (post.data.categories ? (Array.isArray(post.data.categories) ? post.data.categories : [post.data.categories]) : []);
  
  return {
    title: post.data.title,
    url: getPostUrl(post.slug),
    date_iso: post.data.date?.toISOString(),
    date_disp: post.data.date?.toLocaleDateString('ja-JP'),
    description: post.data.description || '',
    tags: tags
  };
});
---

<BaseLayout title="記事一覧" description="城上コードメモの記事一覧">
  <section class="space-y-6">
    <div class="flex flex-col md:flex-row justify-between items-center border-b pb-4 mb-6 gap-4">
      <div>
        <h1 class="text-3xl font-bold">記事一覧</h1>
        <p class="text-gray-600 text-sm mt-1">全{allPosts.length}件の記事があります。</p>
      </div>
      
      <div class="flex flex-col sm:flex-row items-center gap-2 w-full md:w-auto">
        <input 
          id="post-search" 
          type="search" 
          placeholder="キーワード検索..."
          class="w-full sm:w-auto border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow"
        >
        <select 
          id="post-tag" 
          class="w-full sm:w-auto border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white transition-shadow"
        >
          <option value="">すべての区分</option>
          {/* JSが自動でタグを追加します */}
        </select>
      </div>
    </div>

    <div id="posts-container" class="space-y-4 min-h-[200px]">
      {/* 
        初期表示はサーバーサイドレンダリングで出力しておき、
        JS有効時はJSがここを書き換える構成にします（Hydrationライクな挙動）
      */}
      {allPosts.map((post) => {
        const tags = post.data.tags 
          ? (Array.isArray(post.data.tags) ? post.data.tags : [post.data.tags]) 
          : (post.data.categories ? (Array.isArray(post.data.categories) ? post.data.categories : [post.data.categories]) : []);
        const tagText = tags.join(', ');
        const postUrl = getPostUrl(post.slug);

        return (
          <a href={postUrl}
            class="block bg-white p-4 rounded-lg shadow-sm hover:shadow-md transition-shadow group">
            <h2 class="text-lg font-bold group-hover:text-blue-600 transition-colors">{post.data.title}</h2>
            {post.data.description && (
              <p class="text-gray-600 mt-1 line-clamp-2">{post.data.description}</p>
            )}
            <div class="mt-3 flex items-center justify-between text-sm text-gray-500">
              <time datetime={post.data.date?.toISOString()}>{post.data.date?.toLocaleDateString('ja-JP')}</time>
              {tagText ? (
                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-semibold">{tagText}</span>
              ) : (
                <span class="bg-gray-100 text-gray-600 px-2 py-1 rounded-full text-xs">untagged</span>
              )}
            </div>
          </a>
        );
      })}
    </div>
  </section>
</BaseLayout>

{/* データ受け渡し用スクリプト（隠し要素） */}
<script id="posts-data" type="application/json" set:html={JSON.stringify(postsForJson)}></script>

<script>
  (function () {
    // 1) JSONデータの読込
    const dataEl = document.getElementById('posts-data');
    if (!dataEl) return;
    
    const POSTS = JSON.parse(dataEl.textContent || '[]');

    // 2) DOM要素
    const $container = document.getElementById('posts-container');
    const $search = document.getElementById('post-search') as HTMLInputElement;
    const $tag = document.getElementById('post-tag') as HTMLSelectElement;

    if (!$container || !$search || !$tag) return;

    // 3) タグを収集してセレクトに流し込む
    const tagSet = new Set<string>();
    POSTS.forEach((p: any) => {
      if (Array.isArray(p.tags)) {
        p.tags.forEach((t: string) => t && tagSet.add(t));
      }
    });

    const tagList = Array.from(tagSet).sort((a, b) => a.localeCompare(b, 'ja'));
    tagList.forEach(tag => {
      const opt = document.createElement('option');
      opt.value = tag;
      opt.textContent = tag;
      $tag.appendChild(opt);
    });

    // 4) レンダリング関数
    function render(items: any[]) {
      if (items.length === 0) {
        $container!.innerHTML = '<p class="text-gray-500 text-center py-8">該当する記事が見つかりませんでした。</p>';
        return;
      }

      const html = items.map(p => {
        const tagText = Array.isArray(p.tags) ? p.tags.join(', ') : '';
        const tagBadge = tagText
          ? `<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-semibold">${escapeHtml(tagText)}</span>`
          : `<span class="bg-gray-100 text-gray-600 px-2 py-1 rounded-full text-xs">untagged</span>`;
        
        const description = p.description ? `<p class="text-gray-600 mt-1 line-clamp-2">${escapeHtml(p.description)}</p>` : '';

        return `
          <a href="${p.url}" class="block bg-white p-4 rounded-lg shadow-sm hover:shadow-md transition-shadow group">
            <h2 class="text-lg font-bold group-hover:text-blue-600 transition-colors">${escapeHtml(p.title)}</h2>
            ${description}
            <div class="mt-3 flex items-center justify-between text-sm text-gray-500">
              <time datetime="${p.date_iso}">${escapeHtml(p.date_disp)}</time>
              ${tagBadge}
            </div>
          </a>
        `;
      }).join('');

      $container!.innerHTML = html;
    }

    // 5) フィルタ関数
    function filterPosts() {
      const q = ($search.value || '').trim().toLowerCase();
      const t = ($tag.value || '').trim();

      const filtered = POSTS.filter((p: any) => {
        // キーワード検索 (title + description)
        const hay = (p.title + ' ' + (p.description || '')).toLowerCase();
        const okQ = q === '' ? true : hay.includes(q);

        // タグフィルタ (tags 配列に含まれるか)
        const okT = t === '' ? true : (Array.isArray(p.tags) && p.tags.includes(t));

        return okQ && okT;
      });

      render(filtered);
    }

    // 6) イベント登録
    let timer: any = null;
    $search.addEventListener('input', () => {
      clearTimeout(timer);
      timer = setTimeout(filterPosts, 150);
    });
    $tag.addEventListener('change', filterPosts);

    // --- util: 簡易エスケープ ---
    function escapeHtml(s: string) {
      return String(s).replace(/[&<>"']/g, m => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[m as keyof typeof m]));
    }
  })();
</script>
